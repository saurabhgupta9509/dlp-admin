    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DLP Admin Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary: #4361ee;
                --primary-dark: #3a56d4;
                --secondary: #7209b7;
                --success: #06d6a0;
                --warning: #ffd166;
                --danger: #ef476f;
                --dark: #1e1e2d;
                --light: #f8f9fa;
                --gray: #6c757d;
                --gray-light: #e9ecef;
                --border-radius: 12px;
                --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                --transition: all 0.3s ease;
            }

            body {
                font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
                min-height: 100vh;
                color: var(--dark);
                line-height: 1.6;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }

            /* Login Styles */
            .login-container {
                max-width: 420px;
                margin: 100px auto;
                background: white;
                padding: 40px;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                text-align: center;
                position: relative;
                overflow: hidden;
            }

            .login-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
            }

            .login-container h2 {
                margin-bottom: 30px;
                color: var(--dark);
                font-size: 1.8em;
                font-weight: 700;
            }

            .form-group {
                margin-bottom: 20px;
                text-align: left;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: var(--dark);
            }

            .form-control {
                width: 100%;
                padding: 14px;
                border: 2px solid var(--gray-light);
                border-radius: 8px;
                font-size: 15px;
                transition: var(--transition);
                background: #fcfcfc;
            }

            .form-control:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
                background: white;
            }

            .btn-login {
                width: 100%;
                padding: 14px;
                background: linear-gradient(45deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: var(--transition);
                position: relative;
                overflow: hidden;
            }

            .btn-login:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
            }

            .btn-login:active {
                transform: translateY(0);
            }

            .login-error {
                color: var(--danger);
                margin-top: 15px;
                padding: 12px;
                background: rgba(239, 71, 111, 0.1);
                border: 1px solid rgba(239, 71, 111, 0.2);
                border-radius: 6px;
                display: none;
                font-weight: 500;
            }

            /* Dashboard Styles */
            .header {
                background: white;
                padding: 20px 30px;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                margin-bottom: 25px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
                overflow: hidden;
            }

            .header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
            }

            .header h1 {
                color: var(--dark);
                font-size: 2.2em;
                font-weight: 800;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .header-user {
                display: flex;
                align-items: center;
                gap: 15px;
                font-weight: 600;
                color: var(--dark);
            }

            .nav-tabs {
                display: flex;
                background: white;
                border-radius: var(--border-radius);
                padding: 8px;
                margin-bottom: 25px;
                box-shadow: var(--box-shadow);
                overflow-x: auto;
                position: relative;
            }

            .nav-tab {
                padding: 12px 24px;
                margin: 0 4px;
                border: none;
                background: transparent;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 600;
                transition: var(--transition);
                color: var(--gray);
                white-space: nowrap;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .nav-tab.active {
                background: linear-gradient(45deg, var(--primary), var(--secondary));
                color: white;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
            }

            .nav-tab:hover:not(.active) {
                background: var(--light);
                color: var(--dark);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
                animation: fadeIn 0.5s ease;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .card {
                background: white;
                border-radius: var(--border-radius);
                padding: 25px;
                margin-bottom: 25px;
                box-shadow: var(--box-shadow);
                border-left: 4px solid var(--primary);
                transition: var(--transition);
            }

            .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            }

            .card h3 {
                color: var(--dark);
                margin-bottom: 20px;
                font-size: 1.4em;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: white;
                padding: 25px;
                border-radius: var(--border-radius);
                text-align: center;
                box-shadow: var(--box-shadow);
                transition: var(--transition);
                position: relative;
                overflow: hidden;
                border-top: 4px solid var(--primary);
            }

            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
            }

            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            }

            .stat-number {
                font-size: 2.8em;
                font-weight: 800;
                background: linear-gradient(45deg, var(--primary), var(--secondary));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 10px;
                line-height: 1;
            }

            .stat-label {
                color: var(--gray);
                font-weight: 600;
                font-size: 0.95em;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                overflow: hidden;
                border-radius: var(--border-radius);
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }

            th, td {
                padding: 16px;
                text-align: left;
                border-bottom: 1px solid var(--gray-light);
            }

            th {
                background: linear-gradient(45deg, var(--primary), var(--secondary));
                color: white;
                font-weight: 600;
                position: sticky;
                top: 0;
            }

            tr:hover {
                background: rgba(67, 97, 238, 0.05);
            }

            td a {
                color: var(--primary);
                text-decoration: none;
                font-weight: 600;
                transition: var(--transition);
            }
            td a:hover {
                color: var(--secondary);
                text-decoration: underline;
            }

            .btn {
                padding: 10px 18px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: var(--transition);
                margin: 2px;
                font-size: 0.9em;
                display: inline-flex;
                align-items: center;
                gap: 6px;
            }

            .btn-primary { background: var(--primary); color: white; }
            .btn-danger { background: var(--danger); color: white; }
            .btn-success { background: var(--success); color: white; }
            .btn-warning { background: var(--warning); color: var(--dark); }
            .btn-info { background: #17a2b8; color: white; }
            .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
            .btn-sm { padding: 8px 14px; font-size: 0.85em; }
            .btn:active { transform: translateY(0); }

            .hidden { display: none !important; }
            .loading { text-align: center; padding: 40px; color: var(--gray); }
            .notification-badge {
                background: var(--danger);
                color: white;
                border-radius: 50%;
                padding: 4px 8px;
                font-size: 12px;
                font-weight: 700;
                margin-left: 5px;
                min-width: 20px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            /* Policy Wizard */
            .wizard-container {
                margin-top: 20px;
                background: var(--light);
                padding: 20px;
                border-radius: var(--border-radius);
            }

            .wizard-step {
                display: none;
                padding: 20px;
                background: white;
                border-radius: var(--border-radius);
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }

            .wizard-step.active {
                display: block;
                animation: slideIn 0.4s ease;
            }

            @keyframes slideIn {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }

            .wizard-navigation {
                display: flex;
                justify-content: space-between;
                margin-top: 25px;
            }

            .policies-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }

            .policy-card {
                background: white;
                padding: 20px;
                border-radius: 10px;
                border: 2px solid var(--gray-light);
                transition: var(--transition);
                cursor: pointer;
                position: relative;
            }

            .policy-card:hover {
                border-color: var(--primary);
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            }

            .policy-card.selected {
                border-color: var(--primary);
                background: rgba(67, 97, 238, 0.05);
                box-shadow: 0 5px 15px rgba(67, 97, 238, 0.15);
            }

            .policy-card h5 {
                margin-bottom: 10px;
                color: var(--dark);
                font-weight: 600;
            }

            .policy-action {
                margin-top: 10px;
                padding: 10px;
                background: var(--light);
                border-radius: 6px;
                font-size: 0.9em;
            }

            /* Alert Styles */
            .alert-filters {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .filter-btn {
                padding: 10px 18px;
                border: 1px solid var(--gray-light);
                border-radius: 20px;
                background: white;
                cursor: pointer;
                transition: var(--transition);
                font-weight: 500;
            }

            .filter-btn.active {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }

            .filter-btn:hover:not(.active) {
                background: var(--light);
                border-color: var(--primary);
            }

            .action-buttons {
                display: flex;
                gap: 10px;
                margin-top: 15px;
                flex-wrap: wrap;
            }

            /* Agent Selector */
            .agent-selector {
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid var(--gray-light);
                border-radius: var(--border-radius);
                padding: 10px;
                background: white;
            }

            .agent-card {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: var(--transition);
                border-left: 3px solid var(--primary);
            }

            .agent-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            }

            .agent-info {
                display: flex;
                flex-direction: column;
            }

            .agent-name {
                font-weight: 600;
                color: var(--dark);
            }

            .agent-status {
                font-size: 0.8em;
                color: var(--gray);
            }

            .status-active { color: var(--success); font-weight: 600; }
            .status-inactive { color: var(--danger); font-weight: 600; }
            .status-suspended { color: var(--warning); font-weight: 600; }

            /* Toast Notifications */
            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
            }

            .toast {
                padding: 16px 20px;
                margin-bottom: 10px;
                border-radius: var(--border-radius);
                color: white;
                box-shadow: 0 5px 15px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 350px;
            }

            .toast-success { background: var(--success); }
            .toast-error { background: var(--danger); }
            .toast-warning { background: var(--warning); color: var(--dark); }
            .toast-info { background: var(--primary); }

            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(5px);
            }

            .modal-content {
                background: white;
                padding: 30px;
                border-radius: var(--border-radius);
                width: 90%;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            }

            .modal-close {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: var(--gray);
                transition: var(--transition);
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-close:hover {
                color: var(--dark);
                background: var(--light);
            }

            /* Alert Items */
            .alert-item {
                background: white;
                border-radius: var(--border-radius);
                padding: 20px;
                margin-bottom: 15px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.05);
                border-left: 4px solid var(--warning);
                transition: var(--transition);
                animation: slideIn 0.4s ease;
            }

            .alert-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            }

            .alert-item.critical {
                border-left-color: var(--danger);
                background: rgba(239, 71, 111, 0.03);
            }

            .alert-item.high {
                border-left-color: var(--warning);
            }

            .alert-item.medium {
                border-left-color: #17a2b8;
            }

            .alert-item.low {
                border-left-color: var(--success);
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .container {
                    padding: 15px;
                }

                .header {
                    flex-direction: column;
                    gap: 15px;
                    text-align: center;
                    padding: 20px;
                }

                .header h1 {
                    font-size: 1.8em;
                }

                .nav-tabs {
                    flex-wrap: wrap;
                    justify-content: center;
                }

                .nav-tab {
                    padding: 10px 16px;
                    font-size: 0.9em;
                }

                .stats-grid {
                    grid-template-columns: 1fr;
                }

                .policies-grid {
                    grid-template-columns: 1fr;
                }

                .action-buttons {
                    flex-direction: column;
                }

                .wizard-navigation {
                    flex-direction: column;
                    gap: 10px;
                }

                .wizard-navigation button {
                    width: 100%;
                }

                table {
                    display: block;
                    overflow-x: auto;
                }
            }

            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--primary);
                border-radius: 10px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--primary-dark);
            }

            /* Loading Animation */
            .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255,255,255,.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .btn-loading {
                position: relative;
                color: transparent;
            }

            .btn-loading .spinner {
                position: absolute;
                left: 50%;
                top: 50%;
                margin-left: -10px;
                margin-top: -10px;
            }

            /* Empty States */
            .empty-state {
                text-align: center;
                padding: 40px 20px;
                color: var(--gray);
            }

            .empty-state h4 {
                margin-bottom: 10px;
                color: var(--dark);
            }

            /* Status Indicators */
            .status-indicator {
                display: inline-block;
                width: 10px;
                height: 10px;
                border-radius: 50%;
                margin-right: 8px;
            }

            .status-active .status-indicator { background: var(--success); }
            .status-inactive .status-indicator { background: var(--danger); }
            .status-suspended .status-indicator { background: var(--warning); }

            /* Severity Badges */
            .severity-badge {
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 0.75em;
                font-weight: 700;
                text-transform: uppercase;
            }

            .severity-badge.high {
                background: rgba(239, 71, 111, 0.15);
                color: var(--danger);
            }

            .severity-badge.medium {
                background: rgba(255, 209, 102, 0.15);
                color: #b88a00;
            }

            .severity-badge.low {
                background: rgba(6, 214, 160, 0.15);
                color: var(--success);
            }
        </style>
    </head>
    <body>
    <div id="loginScreen">
        <div class="login-container">
            <h2>🔐 DLP Admin Login</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" value="admin">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" value="admin123">
            </div>
            <button class="btn-login" id="loginBtn" onclick="adminLogin()">
                <span id="loginBtnText">Login to Dashboard</span>
            </button>
            <div id="loginError" class="login-error"></div>
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
                <strong>Default Credentials:</strong><br>
                Username: <code>admin</code><br>
                Password: <code>admin123</code>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="container">
            <div class="header">
                <h1>🛡️ DLP Admin Dashboard</h1>
                <div class="header-user">
                    <span id="adminName"></span>
                    <button class="btn btn-danger btn-sm" onclick="logout()">
                        <span>🚪 Logout</span>
                    </button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('overview')">
                    <span>📊</span>
                    <span>Overview</span>
                </button>
                <button class="nav-tab" onclick="showTab('agents')">
                    <span>👥</span>
                    <span>Agents</span>
                </button>
                <button class="nav-tab" onclick="showTab('policies')">
                    <span>📜</span>
                    <span>Protection Policies</span>
                </button>
                <button class="nav-tab" onclick="showTab('alerts')">
                    <span>🚨</span>
                    <span>Alerts</span>
                    <span id="alertBadge" class="notification-badge hidden">0</span>
                </button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAgents">0</div>
                        <div class="stat-label">Total Agents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeAgents">0</div>
                        <div class="stat-label">Active Agents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPolicies">0</div>
                        <div class="stat-label">Total Active Policies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingAlerts">0</div>
                        <div class="stat-label">Pending Alerts</div>
                    </div>
                </div>
                <div class="card">
                    <h3>📈 Recent Activity</h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: center;">
                        <div>
                            <h4>Alerts by Severity</h4>
                            <canvas id="severityPieChart"></canvas>
                        </div>
                        <div style="width: 100%;">
                            <h4>Alerts Last 7 Days</h4>
                            <canvas id="alertsBarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="agents" class="tab-content">
                <div class="card">
                    <h3>👥 Manage Agents</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="loadAgents()">
                            <span>🔄</span>
                            <span>Refresh Agents</span>
                        </button>
                        <button class="btn btn-success" onclick="createTestAgent()">
                            <span>🧪</span>
                            <span>Create Test Agent</span>
                        </button>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Hostname</th>
                            <th>Status</th>
                            <th>Last Heartbeat</th>
                            <th>Policies (Active/Total)</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="agentsTable">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="policies" class="tab-content">
                <div class="card">
                    <h3>🛡️ Assign Protection Policies</h3>
                    <p>Select policies (created dynamically by agents) and assign them to one or more agents.</p>

                    <div class="wizard-container">
                        <div id="wizardStep1" class="wizard-step active">
                            <h4>Step 1: Select Protection Category</h4>
                            <div class="form-group">
                                <label>Choose protection type:</label>
                                <select id="protectionCategory" class="form-control" onchange="loadProtectionPolicies()">
                                    <option value="">Select Category</option>
                                    <option value="USB">💾 USB Protection</option>
                                    <option value="NETWORK">🌐 Network Protection</option>
                                    <option value="FILE">📁 File Protection</option>
                                </select>
                            </div>
                        </div>

                        <div id="wizardStep2" class="wizard-step">
                            <h4>Step 2: Select Protection Policy</h4>
                            <div class="form-group">
                                <label>Choose a specific policy to assign:</label>
                                <div id="policiesContainer" class="policies-grid">
                                    <div class="loading">Select a category first...</div>
                                </div>
                            </div>
                        </div>

                        <div id="wizardStep3" class="wizard-step">
                            <h4>Step 3: Select Agents</h4>
                            <div class="form-group">
                                <label>Choose which agents to protect:</label>
                                <div id="agentsCheckboxList" class="agent-selector">
                                    <div class="loading">Loading agents...</div>
                                </div>
                            </div>
                        </div>

                        <div class="wizard-navigation">
                            <button class="btn btn-warning" onclick="previousWizardStep()" id="prevBtn" style="display: none;">
                                <span>←</span>
                                <span>Previous</span>
                            </button>
                            <button class="btn btn-primary" onclick="nextWizardStep()" id="nextBtn">
                                <span>Next</span>
                                <span>→</span>
                            </button>
                            <button class="btn btn-success" onclick="assignProtectionPolicy()" id="applyBtn" style="display: none;">
                                <span>✅</span>
                                <span>Assign Protection</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="alerts" class="tab-content">
                <div class="card">
                    <h3>🚨 Security Alerts</h3>
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-number" id="totalAlerts">0</div>
                            <div class="stat-label">Total Alerts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="usbAlerts">0</div>
                            <div class="stat-label">USB Alerts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pendingAlertsCount">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="criticalAlerts">0</div>
                            <div class="stat-label">Critical</div>
                        </div>
                    </div>
                </div>
                <div class="alert-filters">
                    <button class="filter-btn active" onclick="filterAlerts('ALL', this)">All Alerts</button>
                    <button class="filter-btn" onclick="filterAlerts('USB', this)">💾 USB</button>
                    <button class="filter-btn" onclick="filterAlerts('FILE', this)">📁 File</button>
                    <button class="filter-btn" onclick="filterAlerts('NETWORK', this)">🌐 Network</button>
                    <button class="filter-btn" onclick="filterAlerts('PENDING', this)">⏳ Pending</button>
                    <button class="filter-btn" onclick="filterAlerts('CRITICAL', this)">🔴 Critical</button>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadAlerts()">
                        <span>🔄</span>
                        <span>Refresh Alerts</span>
                    </button>
                    <button class="btn btn-success" onclick="createTestUSBAlert()">
                        <span>🧪</span>
                        <span>Test USB Alert</span>
                    </button>
                </div>
                <div id="alertsList">
                    <div class="loading">Loading alerts...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <div id="policyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closePolicyModal()">×</button>
            <h3 id="modalAgentName">Policies for Agent</h3>
            <div id="modalPolicyList">
            </div>
        </div>
    </div>
    <div id="editListModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeListEditorModal()">×</button>
            <h3 id="editListTitle">Edit Blocklist</h3>

            <input type="hidden" id="editListAgentId">
            <input type="hidden" id="editListPolicyCode">
            <input type="hidden" id="editListHostname">

            <div class="form-group">
                <label>Currently Blocked Entries:</label>
                <div id="currentBlocklistContainer" class="agent-selector" style="min-height: 100px;">
                </div>
            </div>

            <div class="form-group">
                <label for="newBlocklistItems">Add New Entries (comma-separated):</label>
                <textarea id="newBlocklistItems" class="form-control" placeholder="e.g., new-domain.com, 1.2.3.4"></textarea>
            </div>

            <button class="btn btn-success" style="width: 100%;" onclick="saveBlocklist()">
                <span>💾</span>
                <span>Save Changes</span>
            </button>
        </div>
    </div>
    <script>
        // All JavaScript code remains exactly the same as in the previous version
        // Only the CSS has been enhanced for better visual design

        // --- Global Variables ---
        let currentUser = null;
        let currentWizardStep = 1;
        let selectedPolicyId = null;
        let selectedAgents = [];
        let allAlerts = [];
        let currentAlertFilter = 'ALL';
        let refreshInterval;
        let agentsCache = []; // Cache for agent data
        let severityPieChart = null;
        let alertsBarChart = null;

        // --- API Abstraction ---
        async function callApi(path, options = {}) {
            const defaultOptions = {
                method: 'GET',
                credentials: 'include', // Sends cookies (JSESSIONID)
                headers: { 'Content-Type': 'application/json' },
            };
            const opts = { ...defaultOptions, ...options };

            try {
                const response = await fetch(path, opts);
                const text = await response.text();

                let json;
                try {
                    json = text ? JSON.parse(text) : null;
                } catch (e) {
                    throw new Error("Invalid JSON response from server.");
                }

                if (!response.ok) {
                    const message = (json && json.message) ? json.message : `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(message);
                }
                return json;
            } catch (error) {
                console.error(`API call to ${path} failed:`, error);
                throw error;
            }
        }

        // --- UI Helpers ---
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            // Add icon based on type
            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            else if (type === 'error') icon = '❌';
            else if (type === 'warning') icon = '⚠️';

            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        // --- Authentication Flow ---
        async function checkAuthStatus() {
            try {
                const result = await callApi('/api/auth/check');
                if (result && result.success) {
                    currentUser = result.data;
                    showDashboard();
                    await loadDashboardData();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.warn('Auth check failed, showing login page:', error.message);
                showLogin();
            }
        }

        async function adminLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');

            errorDiv.style.display = 'none';
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Authenticating...';

            try {
                const result = await callApi('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                if (result && result.success) {
                    currentUser = result.data;
                    showDashboard();
                    await loadDashboardData();
                    showToast('Login successful!', 'success');
                }
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Login to Dashboard';
            }
        }

        async function logout() {
            try {
                await callApi('/api/auth/logout', { method: 'POST' });
            } finally {
                currentUser = null;
                showLogin();
                showToast('Logged out successfully.', 'info');
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('adminName').textContent = `Welcome, ${currentUser.username}`;
            }
            startAutoRefresh();
        }

        function showLogin() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            stopAutoRefresh();
        }

        // --- Tab & Data Loading ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            switch (tabName) {
                case 'overview': loadOverviewStats(); break;
                case 'agents': loadAgents(); break;
                case 'policies':
                    loadProtectionPolicies();
<!--                    loadAgentsForWizard();-->
                    break;
                case 'alerts': loadAlerts(); break;
            }
        }

        async function loadDashboardData() {
            try {
                // Load main data in parallel
                await Promise.all([loadAgents(), loadAlerts()]);
                // Load overview stats, which can use cached agent data if available
                await loadOverviewStats();
                 await loadChartData();
            } catch (err) {
                showToast('Failed to load dashboard data.', 'error');
            }
        }


        // ADD THIS NEW FUNCTION to load and render the charts
    async function loadChartData() {
        try {
            // Fetch data from our new endpoints
            const [severityResult, dateResult] = await Promise.all([
                callApi('/api/admin/stats/alerts-by-severity'),
                callApi('/api/admin/stats/alerts-by-date')
            ]);

            // --- 1. Create the Pie Chart (Alerts by Severity) ---
            if (severityResult && severityResult.success) {
                const labels = severityResult.data.map(d => d.severity);
                const data = severityResult.data.map(d => d.count);

                const pieCtx = document.getElementById('severityPieChart').getContext('2d');
<!--                if (window.severityPieChart) window.severityPieChart.destroy(); // Clear old chart-->
                 // THIS IS THE FIX: Check the local variable, not window.
                            if (severityPieChart) {
                                severityPieChart.destroy(); // Clear old chart
                            }

                    severityPieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Alerts by Severity',
                            data: data,
                            backgroundColor: [
                                'rgba(239, 71, 111, 0.8)', // Danger
                                'rgba(255, 209, 102, 0.8)', // Warning
                                'rgba(6, 214, 160, 0.8)',  // Success
                                'rgba(52, 152, 219, 0.8)' // Info
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });
            }

            // --- 2. Create the Bar Chart (Alerts by Date) ---
            if (dateResult && dateResult.success) {
                // Helper to format date as 'YYYY-MM-DD'
                const formatDate = (dateStr) => new Date(dateStr).toISOString().split('T')[0];

                const labels = dateResult.data.map(d => formatDate(d.date));
                const data = dateResult.data.map(d => d.count);

                const barCtx = document.getElementById('alertsBarChart').getContext('2d');

<!--                if (window.alertsBarChart) window.alertsBarChart.destroy(); // Clear old chart-->
                    if (alertsBarChart) {
                            alertsBarChart.destroy(); // Clear old chart
                        }
                alertsBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Alerts per Day',
                            data: data,
                            backgroundColor: 'rgba(67, 97, 238, 0.8)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1 // Only show whole numbers
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

        } catch (error) {
            console.error("Failed to load chart data:", error);
            showToast("Could not load dashboard charts.", "error");
        }
    }


        async function loadOverviewStats() {
            try {
                let agents = agentsCache;
                // If cache is empty, try fetching
                if (agents.length === 0) {
                     const agentsResult = await callApi('/api/admin/agents');
                     if (agentsResult && agentsResult.success) {
                        agents = agentsResult.data || [];
                        agentsCache = agents;
                     }
                }

                const alertsResult = await callApi('/api/admin/alerts/pending');
                const alerts = (alertsResult && alertsResult.success) ? (alertsResult.data || []) : [];

                const totalAgents = agents.length;
                const activeAgents = agents.filter(a => a.status === 'ACTIVE').length;
                const totalActivePolicies = agents.reduce((sum, a) => sum + (a.activePolicyCount || 0), 0);

                document.getElementById('totalAgents').textContent = totalAgents;
                document.getElementById('activeAgents').textContent = activeAgents;
                document.getElementById('pendingAlerts').textContent = alerts.length;
                document.getElementById('totalPolicies').textContent = totalActivePolicies;

            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        // --- Agents Tab ---
        async function loadAgents() {
            const tbody = document.getElementById('agentsTable');
            tbody.innerHTML = `<tr><td colspan="6" class="loading">Loading agents...</td></tr>`;
            try {
                const result = await callApi('/api/admin/agents');
                const agents = (result && result.success) ? result.data : [];
                agentsCache = agents; // Update the cache

                if (agents.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="empty-state">No agents have registered yet.</td></tr>`;
                    return;
                }

                tbody.innerHTML = agents.map(agent => `
                    <tr>
                        <td>${agent.id}</td>
                        <td><a href="#" onclick="event.preventDefault(); openPolicyModal(${agent.id}, '${agent.hostname || ''}');">${agent.hostname}</a></td>
<!--                        <td><span class="status-${agent.status.toLowerCase()}"><span class="status-indicator"></span>${agent.status}</span></td>-->
                            <td><span class="status-${(agent.status || 'INACTIVE').toLowerCase()}">${agent.status || 'INACTIVE'}</span></td>
                        <td>${agent.lastHeartbeat ? new Date(agent.lastHeartbeat).toLocaleString() : 'Never'}</td>
                        <td>${agent.activePolicyCount || 0} / ${agent.capabilityCount || 0}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="openPolicyModal(${agent.id}, '${agent.hostname || ''}')">
                                <span>👁️</span>
                                <span>View Policies</span>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="updateAgentStatus(${agent.id}, '${agent.status === 'ACTIVE' ? 'INACTIVE' : 'ACTIVE'}')">
                                <span>${agent.status === 'ACTIVE' ? '⏸️' : '▶️'}</span>
                                <span>${agent.status === 'ACTIVE' ? 'Deactivate' : 'Activate'}</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAgent(${agent.id})">
                                <span>🗑️</span>
                                <span>Delete</span>
                            </button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state" style="color: var(--danger);">${error.message}</td></tr>`;
            }
        }

        async function updateAgentStatus(agentId, newStatus) {
            const action = newStatus === 'ACTIVE' ? 'activate' : 'deactivate';
            if (!confirm(`Are you sure you want to ${action} this agent?`)) return;
            try {
                await callApi(`/api/admin/agents/${agentId}/status?status=${newStatus}`, { method: 'PUT' });
                showToast(`Agent ${action}d successfully.`, 'success');
                await loadAgents();
                await loadOverviewStats();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteAgent(agentId) {
            if (!confirm('Are you sure you want to delete this agent? This cannot be undone.')) return;
            try {
                await callApi(`/api/admin/agents/${agentId}`, { method: 'DELETE' });
                showToast('Agent deleted successfully.', 'success');
                await loadAgents();
                await loadOverviewStats();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // --- Policy Modal Functions ---
        function closePolicyModal() {
            document.getElementById('policyModal').classList.add('hidden');
        }

       // REPLACE your existing openPolicyModal function with this
   // REPLACE your existing openPolicyModal function with this
    async function openPolicyModal(agentId, hostname) {
        const modal = document.getElementById('policyModal');
        const title = document.getElementById('modalAgentName');
        const content = document.getElementById('modalPolicyList');
        title.textContent = `Policies for: ${hostname}`;
        modal.classList.remove('hidden');
        content.innerHTML = '<div class="loading">Loading policies...</div>';

        try {
            const result = await callApi(`/api/admin/agents/${agentId}/capabilities`);
            if (result && result.success) {
                const categories = result.data || {};
                if (Object.keys(categories).length === 0) {
                    content.innerHTML = '<div class="empty-state">This agent has not reported any capabilities yet.</div>';
                    return;
                }
                content.innerHTML = Object.entries(categories).map(([category, policies]) => `
                    <div style="margin-bottom: 20px;">
                        <h4>${category}</h4>
                        <div class="policies-grid">
                        ${policies.map(p => {
                            const btnClass = p.isActive ? 'btn-warning' : 'btn-success';
                            const btnText = p.isActive ? 'Deactivate' : 'Activate';
                            const btnIcon = p.isActive ? '⏸️' : '▶️';
                            let policyCardHTML = `
                            <div class="policy-card ${p.isActive ? 'selected' : ''}">
                                <h5>${p.name}</h5>
                                <p style="font-size: 0.9em; color: #555;">${p.description}</p>

                                <div class="policy-action" style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong>Status: <span class="${p.isActive ? 'status-active' : 'status-inactive'}">${p.isActive ? 'ACTIVE' : 'INACTIVE'}</span></strong>
                                    <button class="btn ${btnClass} btn-sm" onclick="togglePolicy(${agentId}, '${p.code}', ${p.isActive}, '${hostname}')">
                                        <span>${btnIcon}</span>
                                        <span>${btnText}</span>
                                    </button>
                                </div>
                            `;

                            // --- NEW LOGIC: Add "Edit" button for specific policies ---
                            if (p.code === 'NETWORK_DNS_BLOCK') {
                                // We pass the raw policyData string to the editor function
                                const policyDataString = p.policyData ? p.policyData.replace(/'/g, "\\'") : '{}';
                                policyCardHTML += `
                                <button class="btn btn-primary btn-sm" style="width: 100%; margin-top: 10px;"
                                        onclick='openDnsEditor(${agentId}, "${p.code}", "${hostname}", \`${policyDataString}\`)'>
                                    ✏️ Edit Blocklist
                                </button>
                                `;
                            }
                            // --- END NEW LOGIC ---

                            policyCardHTML += `</div>`;
                            return policyCardHTML;
                        }).join('')}
                        </div>
                    </div>`).join('');
            }
        } catch (error) {
            content.innerHTML = `<div class="empty-state" style="color: var(--danger);">${error.message}</div>`;
        }
    }
        // ADD THESE 3 NEW FUNCTIONS

    function closeListEditorModal() {
        document.getElementById('editListModal').classList.add('hidden');
    }

    /**
     * Opens the editor modal for the DNS blocklist.
     */
    function openDnsEditor(agentId, policyCode, hostname, policyDataString) {
        document.getElementById('editListTitle').textContent = `Edit Blocklist for ${hostname}`;
        document.getElementById('editListAgentId').value = agentId;
        document.getElementById('editListPolicyCode').value = policyCode;
        document.getElementById('editListHostname').value = hostname; // Store for refresh
        document.getElementById('newBlocklistItems').value = ''; // Clear new items

        const container = document.getElementById('currentBlocklistContainer');
        container.innerHTML = ''; // Clear old list

        let policyData = { domains: [], ips: [] };
        try {
            if (policyDataString) {
                policyData = JSON.parse(policyDataString) || policyData;
            }
        } catch(e) { console.warn("Could not parse policy data", policyDataString); }

        const allEntries = [...(policyData.domains || []), ...(policyData.ips || [])];

        if (allEntries.length === 0) {
            container.innerHTML = '<div class="empty-state" style="padding: 10px;">No entries are currently blocked.</div>';
        } else {
            // Render each item as a "selectable" card we can remove
            container.innerHTML = allEntries.map(entry => `
                <div class="agent-card" id="entry-${entry}">
                    <span class="agent-name">${entry}</span>
                    <button class="btn btn-danger btn-sm" onclick="removeBlocklistEntry('${entry}')">
                        &times;
                    </button>
                </div>
            `).join('');
        }

        document.getElementById('editListModal').classList.remove('hidden');
    }

    /**
     * Helper to remove an entry from the list in the modal
     */
    function removeBlocklistEntry(entry) {
        const entryElement = document.getElementById(`entry-${entry}`);
        if (entryElement) {
            entryElement.remove();
        }
    }

    /**
     * Reads all items from the editor modal and saves them
     */
    async function saveBlocklist() {
        const agentId = document.getElementById('editListAgentId').value;
        const policyCode = document.getElementById('editListPolicyCode').value;
        const hostname = document.getElementById('editListHostname').value;

        // 1. Get all *existing* entries that are still in the list
        const existingEntries = Array.from(document.querySelectorAll('#currentBlocklistContainer .agent-name'))
                                     .map(el => el.textContent);

        // 2. Get all *new* entries from the text box
        const newEntryText = document.getElementById('newBlocklistItems').value;
        const newEntries = newEntryText.split(',')
                                       .map(e => e.trim())
                                       .filter(e => e.length > 0);

        // 3. Combine them and remove duplicates
        const allEntries = [...new Set([...existingEntries, ...newEntries])];

        // 4. Separate them back into IPs and Domains (a simple way)
        const domains = allEntries.filter(e => e.includes('.'));
        const ips = allEntries.filter(e => !e.includes('.'));

        const policyDataJson = JSON.stringify({ domains, ips });

        try {
            const body = {
                agentId: agentId, // Make sure agentId is a number
                policyCode: policyCode,
                policyData: policyDataJson
            };

            await callApi('/api/admin/update-policy-data', { method: 'POST', body: JSON.stringify(body) });
            showToast('Blocklist updated successfully!', 'success');

            closeListEditorModal();
            // Refresh the main policy modal to show the new state
            await openPolicyModal(agentId, hostname);

        } catch (error) {
            showToast(`Error updating data: ${error.message}`, 'error');
        }
    }



    async function savePolicyData(agentId, policyCode, hostname) {
        let policyDataJson = null;

        // Find the correct text boxes inside the modal
        if (policyCode === 'NETWORK_DNS_BLOCK') {
            const domainText = document.getElementById(`modal-dns-domains-${agentId}`).value;
            const ipText = document.getElementById(`modal-dns-ips-${agentId}`).value;

            const domains = domainText.split(',').map(d => d.trim()).filter(d => d.length > 0);
            const ips = ipText.split(',').map(ip => ip.trim()).filter(ip => ip.length > 0);

            if (domains.length === 0 && ips.length === 0) {
                showToast('Please enter at least one domain or IP to block.', 'warning');
                return;
            }

            policyDataJson = JSON.stringify({ domains, ips });
        }
        // You can add more 'else if' blocks here for future data-driven policies

        try {
            const body = {
                agentId: agentId,
                policyCode: policyCode,
                policyData: policyDataJson
            };

            await callApi('/api/admin/update-policy-data', { method: 'POST', body: JSON.stringify(body) });
            showToast('Policy data updated successfully!', 'success');

            // Refresh the modal to show the saved data
            await openPolicyModal(agentId, hostname);

        } catch (error) {
            showToast(`Error updating data: ${error.message}`, 'error');
        }
    }

        async function togglePolicy(agentId, policyCode, isCurrentlyActive, hostname) {
            const endpoint = isCurrentlyActive ? '/api/admin/deactivate-protection' : '/api/admin/assign-protection';
            const actionText = isCurrentlyActive ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${actionText} "${policyCode}"?`)) return;

            try {
                await callApi(endpoint, { method: 'POST', body: JSON.stringify({ policyCode, agentIds: [agentId] }) });
                showToast(`Policy ${actionText}d successfully!`, 'success');
                await openPolicyModal(agentId, hostname); // Refresh modal content
                await loadAgents(); // Refresh agent list to update counts
                await loadOverviewStats(); // Refresh overview stats
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // --- Policies Tab (Wizard) ---
        // REPLACE this function
   // REPLACE your existing loadProtectionPolicies function with this one
    async function loadProtectionPolicies() {
        const category = document.getElementById('protectionCategory').value;
        const container = document.getElementById('policiesContainer');
        if (!category) {
            container.innerHTML = '<div class="loading">Select a category first...</div>';
            return;
        }

        try {
            const result = await callApi('/api/admin/protection-policies');
            const policies = (result && result.success && result.data) ? (result.data[category] || []) : [];

            if (policies.length === 0) {
                 container.innerHTML = `<div class="empty-state">No policies found for this category.</div>`;
                 return;
            }

            container.innerHTML = policies.map(policy => {
                let policyCardHTML = `
                <div class="policy-card" onclick="selectPolicy('${policy.policyCode}', this)">
                    <h5>${policy.name}</h5>
                    <p style="font-size: 0.9em; color: #555;">${policy.description}</p>
                    <div class="policy-action">
                        <span><strong>Action:</strong> ${policy.action}</span>
                        <span class="severity-badge ${(policy.severity || 'LOW').toLowerCase()}">${policy.severity || 'N/A'}</span>
                    </div>
                `;

                // --- THIS IS THE NEW LOGIC ---
                // If this is our special DNS policy, add the new selector
                if (policy.policyCode === 'NETWORK_DNS_BLOCK') {
                    policyCardHTML += `
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="dns-block-type">Block Type:</label>
                            <select id="dns-block-type" class="form-control" onchange="showDnsInput()" onclick="event.stopPropagation();">
                                <option value="">Select type...</option>
                                <option value="domains">Block by Domain Name</option>
                                <option value="ips">Block by IP Address</option>
                            </select>
                        </div>

                        <div id="dns-domains-input-group" class="form-group hidden" style="margin-top: 10px;">
                            <label for="dns-block-list-domains">Domains to Block (comma-separated):</label>
                            <textarea id="dns-block-list-domains" class="form-control"
                                      placeholder="e.g., dropbox.com, mega.nz"
                                      onclick="event.stopPropagation();"></textarea>
                        </div>

                        <div id="dns-ips-input-group" class="form-group hidden" style="margin-top: 10px;">
                            <label for="dns-block-list-ips">IPs to Block (comma-separated):</label>
                            <textarea id="dns-block-list-ips" class="form-control"
                                      placeholder="e.g., 8.8.8.8, 1.1.1.1"
                                      onclick="event.stopPropagation();"></textarea>
                        </div>
                    `;
                }
                // --- END OF NEW LOGIC ---

                policyCardHTML += `</div>`;
                return policyCardHTML;

            }).join('');
        } catch (error) {
            container.innerHTML = `<div class="empty-state" style="color: var(--danger);">Error: ${error.message}</div>`;
        }
    }

    // ADD THIS NEW FUNCTION to your <script> tag

    function showDnsInput() {
        const blockType = document.getElementById('dns-block-type').value;
        const domainGroup = document.getElementById('dns-domains-input-group');
        const ipGroup = document.getElementById('dns-ips-input-group');

        // Hide both first
        domainGroup.classList.add('hidden');
        ipGroup.classList.add('hidden');

        // Show the selected one
        if (blockType === 'domains') {
            domainGroup.classList.remove('hidden');
        } else if (blockType === 'ips') {
            ipGroup.classList.remove('hidden');
        }
    }

        // REPLACE your existing loadAgentsForWizard function
   // REPLACE your existing loadAgentsForWizard function with this
    async function loadAgentsForWizard(policyCode) {
        const container = document.getElementById('agentsCheckboxList');
        container.innerHTML = '<div class="loading">Loading compatible agents...</div>';

        // Clear the list of agents to be assigned
        selectedAgents = [];

        try {
            // Call the endpoint, which now returns AgentPolicyStatusDTO list
            const result = await callApi(`/api/admin/agents-with-capability/${policyCode}`);

            if (!result || !result.success) {
                throw new Error(result?.message || 'Failed to load agents');
            }

            const agents = result.data || [];
            if (agents.length === 0) {
                container.innerHTML = `<div class="empty-state">No agents have reported this capability.</div>`;
                return;
            }

            container.innerHTML = agents.map(agent => {
                // --- NEW LOGIC ---
                const isAlreadyActive = agent.isPolicyActive;
                const isDisabled = isAlreadyActive ? 'disabled' : '';
                const statusText = isAlreadyActive ? '<span class="status-active">(Already Active)</span>' : '';
                // --- END NEW LOGIC ---

                return `
                <div class="agent-card">
                    <div class="agent-info">
                        <div class="agent-name">${agent.hostname} ${statusText}</div>
                        <div class="agent-status">ID: ${agent.agentId} | Status: <span class="status-${agent.agentStatus.toLowerCase()}">${agent.agentStatus}</span></div>
                    </div>
                    <input type="checkbox"
                           value="${agent.agentId}"
                           onchange="updateSelectedAgents(${agent.agentId}, this.checked)"
                           ${isDisabled}>
                </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading agents for wizard:', error.message);
            container.innerHTML = `<div class="empty-state" style="color: var(--danger);">Error: ${error.message}</div>`;
        }
    }

        function updateSelectedAgents(agentId, isChecked) {
            const index = selectedAgents.indexOf(agentId);
            if (isChecked && index === -1) selectedAgents.push(agentId);
            else if (!isChecked && index > -1) selectedAgents.splice(index, 1);
        }

        function selectPolicy(policyCode, element) {
            selectedPolicyId = policyCode;
            document.querySelectorAll('#policiesContainer .policy-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
        }

<!--        function nextWizardStep() {-->
<!--            if (currentWizardStep === 1 && !document.getElementById('protectionCategory').value) { showToast('Please select a category.', 'warning'); return; }-->
<!--            if (currentWizardStep === 2 && !selectedPolicyId) { showToast('Please select a policy.', 'warning'); return; }-->
<!--            if (currentWizardStep === 3 && selectedAgents.length === 0) { showToast('Please select at least one agent.', 'warning'); return; }-->
<!--            if (currentWizardStep >= 3) return;-->
<!--            document.getElementById(`wizardStep${currentWizardStep}`).classList.remove('active');-->
<!--            currentWizardStep++;-->
<!--            document.getElementById(`wizardStep${currentWizardStep}`).classList.add('active');-->
<!--            updateWizardNavigation();-->
<!--        }-->
// REPLACE your existing nextWizardStep function with this async version
    async function nextWizardStep() {
        if (currentWizardStep === 1) {
            if (!document.getElementById('protectionCategory').value) {
                showToast('Please select a protection category', 'warning');
                return;
            }
        } else if (currentWizardStep === 2) {
            if (!selectedPolicyId) {
                showToast('Please select a protection policy', 'warning');
                return;
            }
            // --- THIS IS THE NEW LOGIC ---
            // Load the correct agents BEFORE moving to step 3
            await loadAgentsForWizard(selectedPolicyId);
            // --- END NEW LOGIC ---
        }

        // ... (rest of the function to move to the next step)
        document.getElementById(`wizardStep${currentWizardStep}`).classList.remove('active');
        currentWizardStep++;
        document.getElementById(`wizardStep${currentWizardStep}`).classList.add('active');
        updateWizardNavigation();
    }
        function previousWizardStep() {
            if (currentWizardStep <= 1) return;
            document.getElementById(`wizardStep${currentWizardStep}`).classList.remove('active');
            currentWizardStep--;
            document.getElementById(`wizardStep${currentWizardStep}`).classList.add('active');
            updateWizardNavigation();
        }

        function updateWizardNavigation() {
            document.getElementById('prevBtn').style.display = currentWizardStep > 1 ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = currentWizardStep < 3 ? 'block' : 'none';
            document.getElementById('applyBtn').style.display = currentWizardStep === 3 ? 'block' : 'none';
        }

        // REPLACE your existing assignProtectionPolicy function with this one

   // REPLACE your existing assignProtectionPolicy function with this one
    async function assignProtectionPolicy() {
        if (selectedAgents.length === 0 || !selectedPolicyId) {
            showToast('Please select a policy and at least one agent.', 'warning');
            return;
        }

        try {
            let policyDataJson = null; // We will send a JSON string
            let domains = [];
            let ips = [];

            // Check if we are assigning the DNS policy
            if (selectedPolicyId === 'NETWORK_DNS_BLOCK') {
                const blockType = document.getElementById('dns-block-type').value;

                if (blockType === 'domains') {
                    const domainText = document.getElementById('dns-block-list-domains').value;
                    if (!domainText) {
                        showToast('Please enter at least one domain to block.', 'warning');
                        return;
                    }
                    domains = domainText.split(',').map(d => d.trim()).filter(d => d.length > 0);

                } else if (blockType === 'ips') {
                    const ipText = document.getElementById('dns-block-list-ips').value;
                    if (!ipText) {
                        showToast('Please enter at least one IP to block.', 'warning');
                        return;
                    }
                    ips = ipText.split(',').map(ip => ip.trim()).filter(ip => ip.length > 0);

                } else {
                    // No type was selected
                    showToast('Please select a block type (Domain or IP).', 'warning');
                    return;
                }

                // Create a JSON object and stringify it
                const data = { domains, ips };
                policyDataJson = JSON.stringify(data);
            }

            const body = {
                policyCode: selectedPolicyId,
                agentIds: selectedAgents,
                policyData: policyDataJson // Send the JSON string to the backend
            };

            await callApi('/api/admin/assign-protection', { method: 'POST', body: JSON.stringify(body) });
            showToast(`Policy assigned to ${selectedAgents.length} agents!`, 'success');
            resetWizard();

        } catch (error) {
            showToast(`Error: ${error.message}`, 'error');
        }
    }

        function resetWizard() {
            currentWizardStep = 1;
            selectedPolicyId = null;
            selectedAgents = [];
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById('wizardStep1').classList.add('active');
            document.getElementById('protectionCategory').value = '';
            document.getElementById('policiesContainer').innerHTML = '<div class="loading">Select a category first...</div>';
            document.querySelectorAll('#agentsCheckboxList input').forEach(cb => cb.checked = false);
            updateWizardNavigation();
        }

        // --- Alerts Tab ---
          async function loadAlerts() {
            const container = document.getElementById('alertsList');
            container.innerHTML = `<div class="loading">Loading alerts...</div>`;
            try {
                const result = await callApi('/api/admin/alerts/all');

                if (!result || !result.success) {
                    throw new Error(result?.message || 'Failed to load alerts');
                }
                allAlerts = (result && result.success) ? (result.data || []) : [];

                updateAlertStatistics();
                displayFilteredAlerts();

                const pendingCount = allAlerts.filter(a => a.status === 'PENDING').length;
                const badge = document.getElementById('alertBadge');
                badge.textContent = pendingCount;
                badge.classList.toggle('hidden', pendingCount === 0);

            } catch (error) {
                console.error('❌ Error loading alerts:', error.message);
                showAlertError(error.message);
            }
        }

        function showAlertError(message) {
            const container = document.getElementById('alertsList');
            container.innerHTML = `
                <div class="empty-state" style="color: var(--danger);">
                    <h4>❌ Error loading alerts</h4>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadAlerts()" style="margin-top: 10px;">
                        <span>🔄</span>
                        <span>Try Again</span>
                    </button>
                </div>
            `;
        }

      function updateAlertStatistics() {
            const totalAlerts = allAlerts.length;
            const usbAlerts = allAlerts.filter(a => a.alertType && a.alertType.includes('USB')).length;
            const pendingAlerts = allAlerts.filter(a => a.status === 'PENDING').length;
            const criticalAlerts = allAlerts.filter(a => a.severity === 'CRITICAL' || a.severity === 'HIGH').length;

            document.getElementById('totalAlerts').textContent = totalAlerts;
            document.getElementById('usbAlerts').textContent = usbAlerts;
            document.getElementById('pendingAlertsCount').textContent = pendingAlerts;
            document.getElementById('criticalAlerts').textContent = criticalAlerts;
        }

        function displayFilteredAlerts() {
            const container = document.getElementById('alertsList');
            const filtered = filterAlertsByType(allAlerts, currentAlertFilter);
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state">No alerts match this filter.</div>`;
                return;
            }
            container.innerHTML = filtered.map(renderAlertCard).join('');
        }

        function filterAlerts(filter, btnElement) {
            currentAlertFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            displayFilteredAlerts();
        }

        function filterAlertsByType(alerts, filter) {
            if (filter === 'ALL') return alerts;
            return alerts.filter(a => (filter === 'PENDING' && a.status === 'PENDING') || a.alertType?.includes(filter));
        }

        function renderAlertCard(alert) {
            const severity = alert.severity || 'MEDIUM';
            const severityClass = severity.toLowerCase();
            const isPending = alert.status === 'PENDING';

            let alertClass = `alert-item ${severityClass} ${isPending ? 'pending-alert' : ''}`;
            const alertIcon = alert.alertType?.includes('USB') ? '💾' : '🚨';

            const agentName = alert.agentName || 'System';

            return `
                <div class="${alertClass}" id="alert-${alert.id}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2em;">${alertIcon}</span>
                            <div>
                                <strong>${alert.alertType || 'Security Alert'}</strong>
                                <div style="font-size: 0.9em; color: #666; margin-top: 2px;">
                                    Agent: <span style="font-weight: 600;">${agentName}</span> •
                                    Severity: <span class="severity-${severityClass}">${severity}</span> •
                                    Status: <span class="status-${alert.status?.toLowerCase() || 'pending'}">${alert.status || 'PENDING'}</span>
                                </div>
                            </div>
                        </div>
                        <span style="font-size: 0.9em; color: #666;">
                            ${new Date(alert.createdAt).toLocaleString()}
                        </span>
                    </div>

                    <div style="margin-top: 15px;">
                        <p><strong>Description:</strong> ${alert.description || 'No description'}</p>
                        ${alert.deviceInfo ? `<p><strong>Device:</strong> ${alert.deviceInfo}</p>` : ''}
                        ${alert.actionTaken ? `<p><strong>Action Taken:</strong> ${alert.actionTaken}</p>` : ''}
                    </div>

                    ${isPending ? `
                    <div class="action-buttons">
                        <button class="btn btn-info btn-sm" onclick="takeAlertAction(${alert.agentId}, '${agentName}')">
                            <span>⚡</span>
                            <span>Take Action</span>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="handleAlertDecision(${alert.id}, 'RESOLVED')">
                            <span>✅</span>
                            <span>Resolve</span>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="handleAlertDecision(${alert.id}, 'IGNORED')">
                            <span>🤷</span>
                            <span>Ignore</span>
                        </button>
                    </div>
                    ` : `
                    <div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px;">
                        <strong>Decision:</strong> This alert has been ${alert.status.toLowerCase()}
                    </div>
                    `}
                </div>
            `;
        }

        function takeAlertAction(agentId, agentName) {
            if (!agentId) {
                showToast("This alert is not associated with a specific agent.", "warning");
                return;
            }
            showTab('agents');
            openPolicyModal(agentId, agentName);
        }

        async function handleAlertDecision(alertId, decision) {
            try {
                const result = await callApi(`/api/admin/alerts/${alertId}/decision?decision=${encodeURIComponent(decision)}`, { method: 'POST' });

                if (result && result.success) {
                    showToast(`Alert ${decision.toLowerCase()} successfully!`, 'success');
                    await loadAlerts();
                } else {
                    showToast('Error: ' + (result?.message || 'Failed'), 'error');
                }
            } catch (error) {
                console.error('Error handling alert:', error.message);
                showToast('Error handling alert: ' + error.message, 'error');
            }
        }

        async function createTestAgent() {
            try {
                const result = await callApi('/api/admin/agents/create-test', { method: 'POST' });
                if (result && result.success) {
                    showToast('Test agent created!', 'success');
                    await loadAgents();
                } else {
                    showToast('Error: ' + (result?.message || 'Failed to create test agent'), 'error');
                }
            } catch (error) {
                showToast('Error creating test agent: ' + error.message, 'error');
            }
        }

        async function createTestUSBAlert() {
            try {
                const result = await callApi('/api/admin/alerts/create-test?agentId=1&alertType=USB_INSERTION&description=Test+USB+detected&deviceInfo=F:&fileDetails=Test+file+copied', { method: 'POST' });
                if (result && result.success) {
                    showToast('Test alert created!', 'success');
                    await loadAlerts();
                } else {
                    showToast('Error: ' + (result?.message || 'Failed to create test alert'), 'error');
                }
            } catch (error) {
                showToast('Error creating test alert: ' + error.message, 'error');
            }
        }

        // --- Auto-Refresh & Initial Load ---
        function startAutoRefresh() {
            stopAutoRefresh();
            refreshInterval = setInterval(() => {
                const activeTabId = document.querySelector('.tab-content.active')?.id;
                if (activeTabId === 'overview') loadOverviewStats();
                if (activeTabId === 'alerts') loadAlerts();
            }, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
        }

        document.addEventListener('DOMContentLoaded', checkAuthStatus);
        document.getElementById('password').addEventListener('keypress', e => {
            if (e.key === 'Enter') adminLogin();
        });
    </script>
    </body>
    </html>